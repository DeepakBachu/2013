From a8fe15b88d4dc91357276a82e787e04f13d50124 Mon Sep 17 00:00:00 2001
From: Mete Alpaslan <mete@pardus.org.tr>
Date: Tue, 24 Aug 2010 20:18:44 +0300
Subject: [PATCH 119/119] Fixes bootloader inserting reduntant cmdline parameters

Fixes get_commands method not to add unneccassary cmdline parameters at kernel
command line in grub.conf.
---
 yali/storage/bootloader.py |   15 ++++++++++-----
 1 files changed, 10 insertions(+), 5 deletions(-)

diff --git a/yali/storage/bootloader.py b/yali/storage/bootloader.py
index 4a13ae2..a678df3 100644
--- a/yali/storage/bootloader.py
+++ b/yali/storage/bootloader.py
@@ -25,7 +25,7 @@ class KernelError(BootLoaderError):
 
 dos_filesystems = ('FAT', 'fat16', 'fat32', 'ntfs', 'hpfs')
 linux_filesystems = ('ext4', 'ext3', 'reisersfs', 'xfs')
-allParameters = ["root", "initrd","init","xorg","yali","BOOT_IMAGE","lang","mudur"]
+allParameters = ["root", "initrd","init","xorg","yali","BOOT_IMAGE","lang","mudur", "copytoram"]
 
 BOOT_TYPE_NONE = 0
 BOOT_TYPE_MBR = 1
@@ -54,16 +54,21 @@ def get_configs(rootpath):
         return (release, kernel, initramfs)
 
 def get_commands(storage):
+    def is_required(parameter):
+        for p in allParameters:
+            if parameter.startswith("%s=" % p):
+                return False
+        return True
+
     _commands = []
     _commands.append("root=%s" % (storage.rootDevice.fstabSpec))
 
     if storage.storageset.swapDevices:
         _commands.append("resume=%s" % storage.storageset.swapDevices[0].path)
 
-    for command in [cmd for cmd in open("/proc/cmdline", "r").read().split()]:
-        for parameter in allParameters:
-            if not command.startswith("%s=" % parameter):
-                _commands.append(command)
+    for parameter in [x for x in open("/proc/cmdline", "r").read().split()]:
+        if is_required(parameter):
+            _commands.append(parameter)
 
     return " ".join(_commands).strip()
 
-- 
1.7.2.1

